<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Корзина - Книжный магазин</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
</head>
<body>
    <nav>
        <a href="/home" class="logo">Книжный магазин</a>
        <ul>
            <li><a href="/home">Главная</a></li>
            <li><a href="/catalog">Каталог</a></li>
            <li>
                <a href="/cart" class="cart-link">
                    Корзина
                    <% if (typeof cartItemsCount !== 'undefined' && cartItemsCount > 0) { %>
                    <span class="cart-badge"><%= cartItemsCount %></span>
                    <% } %>
                </a>
            </li>
            <% if (typeof user !== 'undefined' && user) { %>
            <li>
                <a href="/profile" class="user-info">
                    <% if (typeof userAvatar !== 'undefined' && userAvatar) { %>
                    <img src="<%= userAvatar %>" alt="Avatar" class="user-avatar">
                    <% } else { %>
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;"></span>
                    <% } %>
                    Профиль
                </a>
            </li>
            <li><a href="/logout">Выйти</a></li>
            <% } else { %>
            <li><a href="/login">Войти</a></li>
            <% } %>
        </ul>
    </nav>

    <div class="content-wrapper">
        <h1>Корзина</h1>
        
        <% if (cartItems && cartItems.length > 0) { %>
        <div id="cartItems">
            <% cartItems.forEach(item => { %>
            <div class="cart-item" id="item-<%= item.id %>">
                <div class="cart-item-info">
                    <h3><%= item.Product.name %></h3>
                    <div class="category"><%= item.Product.category || 'Без категории' %></div>
                    <div class="price"><%= item.Product.price %> ₽ × <%= item.quantity %> = <%= (parseFloat(item.Product.price) * item.quantity).toFixed(2) %> ₽</div>
                </div>
                <div class="cart-item-controls">
                    <div class="quantity-control">
                        <button class="btn btn-small btn-primary" onclick="updateQuantity(<%= item.id %>, <%= item.quantity - 1 %>)">-</button>
                        <input type="number" id="qty-<%= item.id %>" value="<%= item.quantity %>" min="1" max="<%= item.Product.stock %>" readonly>
                        <button class="btn btn-small btn-primary" onclick="updateQuantity(<%= item.id %>, <%= item.quantity + 1 %>)">+</button>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeItem(<%= item.id %>)">Удалить</button>
                </div>
            </div>
            <% }); %>
        </div>
        
        <div class="cart-total">
            <h2>Итого: <span id="totalPrice"><%= totalPrice.toFixed(2) %></span> ₽</h2>
            <button class="btn btn-primary" onclick="checkout()">Оформить заказ</button>
        </div>
        <% } else { %>
        <div class="empty-cart">
            <h2>Ваша корзина пуста</h2>
            <p>Добавьте товары из каталога</p>
            <a href="/catalog" class="btn btn-primary">Перейти в каталог</a>
        </div>
        <% } %>
    </div>

    <script>
        function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) {
                removeItem(itemId);
                return;
            }
            
            fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ itemId: itemId, quantity: newQuantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Ошибка при обновлении количества');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка');
            });
        }

        function removeItem(itemId) {
            if (!confirm('Удалить товар из корзины?')) {
                return;
            }
            
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ itemId: itemId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Ошибка при удалении товара');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка');
            });
        }

        function checkout() {
            alert('Функция оформления заказа будет реализована позже. Спасибо за интерес!');
        }
    </script>
</body>
</html>

